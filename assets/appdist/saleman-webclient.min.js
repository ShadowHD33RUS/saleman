/*! saleman-webclient 2015-10-09 */
function loadApplication(){angular.bootstrap(document.body,["saleman"]),$("#appPreloader").css("display","none"),$("#hiden").css("display","block")}function overrideLogic(a,b){for(var c in a)b[c]&&"Object"==typeof b[c]&&(a[c]=b[c])}function Model(a){var b=this,c={};for(var d in a)a[d]&&a[d].type?(c[d]={},"string"===a[d].type?this[d]={data:a[d].initial?a[d].initial:"",valid:!0}:"number"===a[d].type?this[d]={data:a[d].initial?a[d].initial:0,valid:!0}:"date"===a[d].type&&(this[d]={data:a[d].initial?a[d].initial:new Date,valid:!0})):this[d]={data:"",valid:!0};this.validate=function(){var b=!0;for(var c in a)this[c].valid=!0,a[c].required||this[c].data.length>0?(a[c].eq&&this[c].data!==this[a[c].eq].data?(this[c].valid=!1,this[c].cause="eq",this[c].msg=a[c].err?a[c].err:"This field must be equal to "+c):"string"===a[c].type?a[c].regexp?a[c].regexp.test(this[c].data)||(this[c].valid=!1,this[c].cause="regexp",this[c].msg=a[c].err?a[c].err:"Regexp is not matching"):(a[c].min&&this[c].data.length<a[c].min&&(this[c].valid=!1,this[c].cause="short",this[c].msg=a[c].err?a[c].err:"too short. min - "+(a[c].min-1)),a[c].max&&this[c].data.length>a[c].max&&(this[c].valid=!1,this[c].cause="long",this[c].msg=a[c].err?a[c].err:"too long. max - "+(a[c].max+1))):"number"===a[c].type&&(a[c].min&&this[c].data<a[c].min&&(this[c].valid=!1,this[c].cause="short",this[c].msg=a[c].err?a[c].err:"Number must be greater than "+(a[c].min-1)),a[c].max&&this[c].data>a[c].max&&(this[c].valid=!1,this[c].cause="long",this[c].msg=a[c].err?a[c].err:"Number must be less than "+(a[c].max+1))),b&=this[c].valid):this[c].valid=!0;return this.valid=b,this.valid},this.toJson=function(c){var d={};return jQuery.each(a,function(a,e){c&&null!=c[a]||(d[a]=b[a].data)}),d},this.clearData=function(){jQuery.each(a,function(a,c){"string"===c.type?b[a].data="":"number"===c.type&&(b[a].data=0)})},this.populate=function(c){for(var d in a)c[d]&&(typeof c[d]).toLowerCase()===a[d].type&&(b[d].data=c[d])}}jQuery(document).ready(function(){jQuery(".button-collapse").sideNav();var a=localStorage.getItem("app_cache");a?(a=JSON.parse(a),a.tokens&&a.tokens.refresh?$.ajax({url:"http://185.87.49.173:8080/saleman/oauth/token?grant_type=refresh_token&client_id=web-client&refresh_token="+a.tokens.refresh,dataType:"json",contentType:"application/json",success:function(a){var b={accessToken:a.access_token,refreshToken:a.refresh_token,expiresIn:a.expires_in};$.ajax({url:"http://185.87.49.173:8080/saleman/api/account/getInfo?access_token="+a.access_token,dataType:"json",method:"POST",contentType:"application/json",success:function(a){b.email=a.account.email,b.firstname=a.account.firstname,b.lastname=a.account.lastname,b.patron=a.account.patron,b.getFullName=function(){return this.lastname+" "+this.firstname+" "+this.patron},b.perms={},$.each(a.account,function(a,c){var d=a.indexOf("Permission");-1!=d&&(b.perms[a.substring(0,d)]=c)}),b.isAdmin=a.account.admin,b.blocked=a.company.blocked,b.nextPayment=a.account.next_payment;var c=CryptoJS.enc.Utf8.parse(b.email+b.getFullName());b.cipherKey=CryptoJS.enc.Base64.stringify(c),angular.currentUser=b,loadApplication()},error:function(){loadApplication()}})},error:function(){loadApplication()}}):loadApplication()):loadApplication()});var app=angular.module("saleman",["ngRoute","api","notify","converter"]);app.directive("viewDropdown",function(){return function(a,b,c){a.$last&&jQuery(".dropdown-button").dropdown({inDuration:300,outDuration:225,constrain_width:!1,hover:!0,gutter:0,belowOrigin:!1})}}),app.run(["$rootScope","$location","api","notification",function(a,b,c,d){a.$on("$routeChangeStart",function(a,e,f){if(c.isLoggedIn()||"app/components/login/login.html"===e.templateUrl||"app/components/registration/registration.html"===e.templateUrl||"app/components/recover/recover.html"===e.templateUrl){var g=e.templateUrl.substring(15,e.templateUrl.indexOf("/",15));c.isLoggedIn()&&c.getCurrentUser().blocked&&("payment"!==g||"accounts"!==g||"clients"!==g)&&(d.info("Ваш аккаунт заблокирован"),d.info("Пожалуйста, оплатите для дальнейшего пользования"),b.path("/payment"))}else d.info("Необходимо войти в систему"),b.path("/login")})}]),app.config(["$routeProvider",function(a){a.when("/login",{templateUrl:"app/components/login/login.html",controller:"LoginController",controllerAs:"loginCtrl"}).when("/register",{templateUrl:"app/components/registration/registration.html",controller:"RegistrationController",controllerAs:"regCtrl"}).when("/clients",{templateUrl:"app/components/clients/clients.html",controller:"ClientsController",controllerAs:"clientsCtrl"}).when("/scripts",{templateUrl:"app/components/scripts/scripts.html",controller:"ScriptsController",controllerAs:"scriptsCtrl"}).when("/scripttree/:scriptId",{templateUrl:"app/components/script_editor/script_editor.html",controller:"ScriptEditorController",controllerAs:"editorCtrl"}).when("/scriptrun/:scriptId",{templateUrl:"app/components/script_run/scriptrun.html",controller:"ScriptRunController",controllerAs:"scriptRunCtrl"}).when("/support",{templateUrl:"app/components/support/support.html",controller:"SupportController",controllerAs:"supportCtrl"}).when("/convert",{templateUrl:"app/components/convert/convert.html",controller:"ConvertController",controllerAs:"convertCtrl"}).when("/accounts",{templateUrl:"app/components/accounts/accounts.html",controller:"AccountsController",controllerAs:"accountsCtrl"}).when("/recover",{templateUrl:"app/components/recover/recover.html",controller:"RecoverController",controllerAs:"recoverCtrl"}).when("/notready",{templateUrl:"app/components/notready/notready.html"}).when("/scripttextedit/:id",{templateUrl:"app/components/script_texteditor/script_texteditor.html",controller:"ScriptTextEditorController",controllerAs:"scriptEditCtrl"}).when("/scripttextedit/:id/:nodeId",{templateUrl:"app/components/script_texteditor/script_texteditor.html",controller:"ScriptTextEditorController",controllerAs:"scriptEditCtrl"}).otherwise({redirectTo:"/login"})}]),app.controller("AccountsController",["api","notification","$rootScope",function(a,b,c){var d=this;this.model=new Model({account_id:{type:"number"},firstname:ModelConfig.firstName(!0),lastname:ModelConfig.lastName(!1),patron:ModelConfig.patron(!1),email:ModelConfig.email(!0),password:ModelConfig.password(!1)}),this.perms={scriptEditPermission:!1,clientReadPermission:!1,clientEditPermission:!1},this.searchString="",this.accounts=[],this.filteredAccounts=[],this.save=function(){e(!1),this.model.account_id.data>0?a.updateAccount(this.model.toJson(),function(b){"1"!==b.code?e(!0):a.setPermission(d.model.account_id.data,d.perms,function(){e(!0)})},function(){e(!0)}):a.createAccount(this.model.toJson(),function(b){"1"!==b.code?e(!0):a.setPermission(b.account_id,d.perms,function(){e(!0)})})},this.createNew=function(){this.model.clearData(),jQuery("#editor").find("label").removeClass("active"),e(!0)},this.selectAccount=function(b){e(!1),this.model.account_id.data=b.manager_id,this.model.populate(b),a.getAccount(b.manager_id,function(a){d.model.populate(a.account.account);for(var b in d.perms)d.perms[b]=a.account.account[b];e(!0),c.$digest()})},this.doSearch=function(){d.filteredAccounts=[],jQuery.each(d.accounts,function(a,b){-1!==b.email.toLowerCase().indexOf(d.searchString.toLowerCase())&&d.filteredAccounts.push(b)})},this.isActive=function(a){return a===this.currentAccount};var e=function(a){a?(jQuery("#editor").find("input").removeAttr("disabled"),jQuery("#editor").find("label").addClass("active"),jQuery("#editor").find("a.btn").removeClass("disabled")):(jQuery("#editor").find("input").attr("disabled","true"),jQuery("#editor").find("a.btn").addClass("disabled"))};e(!1),d.filteredAccounts=a.findAccounts(0,function(a){d.accounts=a.managers,d.filteredAccounts=d.accounts,c.$digest()}),d.accounts=d.filteredAccounts}]),app.controller("ClientsController",["api","$rootScope","modal","notification",function(a,b,c,d){var e=this;this.loaded=!1,this.dataLoading=!1,this.clients=[],this.searchString="",this.currentClient={},this.clientModel=new Model({email:ModelConfig.email(!1),firstname:ModelConfig.firstName(!0),lastname:ModelConfig.lastName(!1),patron:ModelConfig.patron(!1),phone:ModelConfig.phone(!1)}),this.doSearch=function(){e.dataLoading=!0,e.searchString.length>0?e.clients=a.findClients(e.searchString,function(a){e.clients=a.clients,e.dataLoading=!1,e.loaded||(e.loaded=!0),b.$digest()}):e.clients=a.getAllClients(function(a){e.clients=a.clients,e.dataLoading=!1,e.loaded||(e.loaded=!0),b.$digest()}),e.clients&&(e.loaded=!0)},this.edit=function(a){for(var b in a)e.clientModel[b]&&(e.clientModel[b].data=a[b]);e.clientModel.client_id=a.client_id,jQuery("#clientModal").openModal()},this.save=function(){e.clientModel.validate(),e.clientModel.valid?(jQuery("#clientModal").closeModal(),this.dataLoading=!0,e.clientModel.client_id?a.updateClient(e.clientModel.toJson([]),function(){e.dataLoading=!1}):a.addClient(e.clientModel.toJson([]),function(a){e.clients=a,e.dataLoading=!1,b.$digest()})):d.info("Исправьте данные")},this.create=function(){e.clientModel.clearData(),delete e.clientModel.client_id,jQuery("#clientModal").openModal()},this.remove=function(d){var f=d;c.okCancelDialog("Вы уверены, что хотите удалить клиента?",function(){e.dataLoading=!0,b.$digest(),e.clients=a.removeClient(f,function(){e.doSearch()},function(){e.dataLoading=!0,f.id=void 0,a.addClient(f,function(){e.doSearch()},!0)})},null,"Внимание")},this.doSearch()}]),app.controller("ConvertController",["api","notification","script_converter",function(a,b,c){this.apiSupport=!1,this.importScript=function(){for(var d=jQuery("#oldFile")[0],e=0;e<d.files.length;e++){var f=jQuery("#oldFile").parent().parent().find('input[type="text"]').val().substr(0,20);c.convert(d.files[e],f,function(c){c&&a.addScript(c,function(){b.info("Импортирование завершено")})})}},window.File&&window.FileReader?this.apiSupport=!0:b.info("Импорт не будет работать. Обновите ваш браузер")}]),app.controller("LoginController",["$location","api","$scope","$rootScope","$timeout","notification",function(a,b,c,d,e,f){this.model=new Model({login:ModelConfig.email(!0),password:ModelConfig.password(!0)}),this.validate=function(){this.model.validate()},this.doLogin=function(){void 0===this.model.valid&&this.model.validate(),this.model.valid?($("#sendButton").addClass("disabled"),b.login(this.model.login.data,this.model.password.data,function(b){b.error?(f.info("Неверная пара логин/пароль"),$("#sendButton").removeClass("disabled")):($("#sendButton").removeClass("disabled"),a.path("/dialogs"),c.$digest(),d.$broadcast("authChange",{}))},function(a){f.info("Ошибка сервера"),$("#sendButton").removeClass("disabled")})):f.info("Исправьте поля с красным цветом")}}]),app.controller("RecoverController",["$location","api","$scope","$rootScope","$timeout","notification",function(a,b,c,d,e,f){this.model=new Model({email:ModelConfig.email(!0)}),this.validate=function(){this.model.validate()},this.doRecover=function(){void 0===this.model.valid&&this.model.validate(),this.model.valid?($("#sendButton").addClass("disabled"),b.sendRecoverEmail(this.model.email.data)):f.info("Исправьте поля с красным цветом")}}]),app.controller("RegistrationController",["$location","api","$scope","notification",function(a,b,c,d){this.user=new Model({email:ModelConfig.email(!0),password:ModelConfig.password(!0),password2:ModelConfig.password_retype("password",!0),first_name:ModelConfig.firstName(!0),last_name:ModelConfig.lastName(!0),patron:ModelConfig.patron(!0)}),this.register=function(){if(this.user.valid){$("#sendButton").addClass("disabled");var e=this.user.toJson(["password2"]);b.register(e,function(){$("#sendButton").addClass("disabled"),d.info("Вы успешно зарегистрировались. Теперь можете войти в систему"),a.path("/login"),c.$apply()},function(a){$("#sendButton").removeClass("disabled"),d.info("Сервер ответил ошибкой")})}else d.info("Исправьте поля с красным цветом")},this.user.validate()}]),app.controller("ScriptEditorController",["$rootScope","$routeParams","api","notification","modal","$location",function(a,b,c,d,e,f){function g(a){for(var b=0;b<a.length;b++)if(a[b])return!1;return!0}function h(a){a=a||window.event;var b=a.deltaY||a.detail||a.wheelDelta;a.preventDefault(),0>b?(l.zoomToPoint(t,1.1*l.getZoom()),s.x*=1.1,s.y*=1.1):(l.zoomToPoint(t,l.getZoom()/1.1),s.x*=1.1,s.y*=1.1)}function i(){f.path("/scripttextedit/"+j.scriptId),a.$digest()}var j=this;this.scriptName="",this.isLoading=!0,this.quickLinks=[],this.scriptId=-1,this.removeQuickLink=function(b){var c=[];jQuery.each(this.quickLinks,function(a,d){b!=d&&c.push(d)}),this.quickLinks=c,a.$digest()},this.switchToTextMode=function(){jQuery("#saveScript").click(),this.scriptId>=0&&(f.path("/scripttextedit/"+j.scriptId),a.$digest())},this.addNew=function(){if(p&&p.treelib_type===treelib.NODE)if(!p.treelib_model.isAnswer||g(p.treelib_model.children))if(p.treelib_model.nextScript)e.info("Выбранный объект ссылается на другой скрипт","Ошибка");else{var a=new treelib.Node({id:m.generateId(),text:"Новый элемент",isAnswer:!p.treelib_model.isAnswer,linksTo:[]});m.add(a),m.connect(p.treelib_model,a),m.buildTree(p.treelib_model.id)}else e.info("У объекта типа 'ответ' может быть только одна выходная стрелка","Ошибка");else e.info("Для создания нового объекта необходимо выбрать какой-либо из уже существующих на диаграмме","Ошибка")},this.saveScript=function(){n.data=m.saveToJson(),n.name=j.scriptName,o?c.addScript(n,function(a){n.id=a.script_id,j.scriptId=a.script_id,i(),o=!1}):c.updateScript(n,function(){})},this.addToFast=function(){p&&p.treelib_type===treelib.NODE?p.treelib_model.setQuickLink(!0)?(j.quickLinks.push(p.treelib_model),a.$digest()):e.info("Нужно выбрать узел с ответом клиента, а не с вопросом менеджера","Ошибка"):e.info("Необходимо выбрать узел","Ошибка")},this.addTransition=function(){d.info("Простите, данная функция временно не поддерживается")},this.buildTree=function(){p&&p.treelib_type===treelib.NODE?m.buildTree(p.treelib_model.id):m.buildTree()};var k=jQuery('<canvas id="canv" width="'+jQuery("#treelib-holder").width()+'" height="500"></canvas>'),l=null,m=null,n=null,o=!1,p=null,q=!1,r=null,s=new fabric.Point(0,0),t=new fabric.Point(0,0);if(jQuery("#treelib-holder").append(k),l=new fabric.Canvas("canv",{selection:!1,hoverCursor:"pointer"}),m=new treelib.Diagram(l),"0"!=b.scriptId&&(this.scriptId=1*b.scriptId),this.scriptId>0)c.findScriptById(this.scriptId,function(b){b.data=JSON.parse(b.script.json_string),n=b,m.loadFromJson(n.data),m.init(),j.quickLinks=m.getQuickLinks(),j.scriptName=n.script.script_name,j.isLoading=!1,a.$digest()});else{this.isLoading=!1;var n={name:"Новый скрипт",data:[{id:1,text:"Точка входа",isAnswer:!1,startPoint:!0,linksTo:[2,3]},{id:2,text:"Вариант ответа 1",isAnswer:!0,linksTo:[4]},{id:3,text:"Вариант ответа 2",isAnswer:!0,linksTo:[4]},{id:4,text:"Выход из скрипта",isAnswer:!1,linksTo:[]}]};m.loadFromJson(n.data),m.init(),m.buildTree(),j.quickLinks=m.getQuickLinks(),o=!0,j.scriptName=n.name}l.on("mouse:down",function(a){var b=jQuery("#textEditor");if(a.target){if(a.target.treelib_type===treelib.NODE)if(a.e.shiftKey&&null!=p){var c=m.connect(p.treelib_model,a.target.treelib_model);1===c?e.info("Нельзя соединить уже соединенные объекты","Ошибка"):2===c?e.info("Объекты одного типа нельзя соединять - вопросы с ответами, ответы с вопросами","Ошибка"):3===c&&e.info("Узел уже ссылается на другой скрипт","Ошибка")}else b.removeAttr("disabled"),b.val(a.target.treelib_model.getText());p=a.target}else b.attr("disabled",""),b.val(""),q=!0,p=null}),l.on("mouse:move",function(a){if(!q){var b=l.getPointer(a.e);t.x=b.x,t.y=b.y}}),jQuery("#treelib-holder")[0].addEventListener?"onwheel"in document?jQuery("#treelib-holder")[0].addEventListener("wheel",h):"onmousewheel"in document?jQuery("#treelib-holder")[0].addEventListener("mousewheel",h):jQuery("#treelib-holder")[0].addEventListener("MozMousePixelScroll",h):jQuery("#treelib-holder")[0].attachEvent("onmousewheel",h),jQuery(window).mouseup(function(){q=!1,r=null}),jQuery(window).mousemove(function(a){q&&(null!==r&&(s.x=a.pageX-r[0],s.y=a.pageY-r[1],l.relativePan(s)),r=[a.pageX,a.pageY])}),jQuery("#textEditor").keyup(function(){p&&p.treelib_model.setText(jQuery("#textEditor").val())}),jQuery(window).keydown(function(a){p&&46===a.keyCode&&(m.remove(p.treelib_model)||e.info("В дереве скрипта должен оставаться хотя бы один вопрос","Ошибка"),p=null)})}]),app.controller("ScriptRunController",["api","$rootScope","$routeParams","notification","modal",function(a,b,c,d,e){function f(a){for(var b="",c=a.indexOf("(("),d=0;-1!=c;){b+=a.substring(d,c);var e=a.indexOf("))",c),f=a.substring(c+2,e),g=f.split(".");if(2===g.length&&("manager"===g[0]?"name"===g[1]&&(b+=h.manager.name):"client"===g[0]&&"name"===g[1]&&(b+=h.client.name)),d=e+2,c=a.indexOf("((",d),-1===c){b+=a.substr(d);break}}return b.trim().length>0?b:a}function g(a){h.step.questionId=a,h.step.question=f(h.nodes[a].text),h.step.answers=[],jQuery.each(h.nodes[a].linksTo,function(a,b){if(b){var c=saleman_misc.findFirstNotNullElement(h.nodes[b].linksTo);h.step.answers.push({text:h.nodes[b].text,next:c?c:!1})}})}var h=this;this.ready=!1,this.nodes={},this.scriptId=-1,this.isLoading=!0,this.manager={name:a.getCurrentUser().firstname},this.client={name:"",phone:"",address:""},this.step={questionId:-1,question:"Загрузка...",answers:[]},this.quickLinks=[],this.selectAnswer=function(a){this.hasNext()&&i.data.splice(i.current+1,i.data.length-i.current-1),i.current=i.data.length-1,a.next?(g(a.next),0===this.step.answers.length&&(this.step.answers=[{text:"Завершить выполнение скрипта"}]),i.data.push(saleman_misc.copyObj(this.step)),i.current=i.data.length-1):(this.step.question="Выполнение скрипта завершено",this.step.answers=[],i.current++)},this.hasNext=function(){return i.data.length>i.current+1?!0:!1},this.hasPrev=function(){return i.data[i.current-1]?!0:!1},this.next=function(){if(this.hasNext()){var a=i.data[++i.current];g(a.questionId)}},this.prev=function(){if(this.hasPrev()){var a=i.data[--i.current];g(a.questionId)}},this.setQuickLink=function(a){g(saleman_misc.findFirstNotNullElement(this.nodes[a].linksTo)),i.data.push(saleman_misc.copyObj(this.step)),i.current=i.data.length-1},this.saveClient=function(){var b=this.client.name.trim().split(" ");1==b.length?j.firstname.data=b[0]:2==b.length?(j.firstname.data=b[0],j.patron.data=b[1]):3==b.length?(j.lastname.data=b[0],j.firstname.data=b[1],j.patron.data=b[2]):e.info('В поле "Имя клиента" должно быть либо имя, либо имя-отчество, либо фамилия-имя-отчество'),j.phone.data=this.client.phone,j.email.data=this.client.address,j.validate(),j.valid?a.addClient(j.toJson()):d.info("Данные в форме неверны")};var i={current:0,data:[]},j=new Model(Models.client({}));c.scriptId&&(this.scriptId=1*c.scriptId),a.findScriptById(this.scriptId,function(a){a.data=JSON.parse(a.script.json_string),h.script=a;var c=null;jQuery.each(a.data,function(a,b){h.nodes[b.id]=b,b.startPoint&&(c=b.id),b.quickLink&&h.quickLinks.push(b)}),g(c),i.data.push(saleman_misc.copyObj(h.step)),i.current=i.data.length-1,h.isLoading=!1,b.$digest()})}]),app.controller("ScriptTextEditorController",["api","$rootScope","$routeParams","notification","modal","$scope","$location",function(a,b,c,d,e,f,g){function h(a){var b=l.nodes[a],c={questionId:a,question:b.text,answers:[]};jQuery.each(b.linksTo,function(a,b){if(b&&l.nodes[b]){var d=l.nodes[b],e=saleman_misc.findFirstNotNullElement(d.linksTo);c.answers.push({id:d.id,text:d.text,next:e?e:!1})}}),k.step.questionId>0&&(l.nodes[k.step.questionId].text=k.step.question,jQuery.each(k.step.answers,function(a,b){l.nodes[b.id].text=b.text})),k.step=c,setTimeout(function(){jQuery(".dropdown-button").dropdown({inDuration:300,outDuration:225,constrain_width:!1,hover:!1,gutter:0,belowOrigin:!1,alignment:"left"}),jQuery("[data-tooltip]").filter(":not([data-tooltip-id])").tooltip({delay:100})},0)}function i(){var a,b=-1;for(var c in l.nodes)c=parseInt(c),c>b&&(b=c);return a={id:b+1,isAnswer:!0,linksTo:[],quickLink:!1,startPoint:!1,text:"Новый ответ"}}function j(){var a=i();return a.text="Новый вопрос",a.isAnswer=!1,a}var k=this;this.isLoading=!1,this.quickLinks=[],this.step={questionId:-1,question:"",answers:[]},this.scriptId=-1,this.newAnswer={id:-1,text:"Новый ответ",linkTo:-1,filtered:[],search:"",clear:function(){this.text="Новый ответ",this.linkTo=-1,this.filtered=[],this.search="",this.id=-1}},this.scriptName="123",this.hasNext=function(){return m.data.length>m.current+1?!0:!1},this.hasPrev=function(){return m.data[m.current-1]?!0:!1},this.next=function(){if(this.hasNext()){var a=m.data[++m.current];h(a.questionId)}},this.prev=function(){if(this.hasPrev()){var a=m.data[--m.current];h(a.questionId)}},this.doSearch=function(){var a=[],b=this.newAnswer.search;for(var c in l.nodes)l.nodes[c]&&!l.nodes[c].isAnswer&&-1!==l.nodes[c].text.toLowerCase().indexOf(b.toLowerCase())&&a.push(l.nodes[c]);this.newAnswer.filtered=a},this.saveScript=function(b){var c={data:[],name:""};jQuery.each(l.nodes,function(a,b){c.data.push(b)}),c.name=this.scriptName,k.scriptId?(c.id=k.scriptId,a.updateScript(c,function(){b(c.id)})):a.addScript(c,function(a){b(a.script_id)})},this.switchToTree=function(){this.saveScript(function(a){g.path("/scripttree/"+a),b.$digest()})},this.removeAnswer=function(a){delete l.nodes[a.id],saleman_misc.removeElement(a.id,l.nodes[this.step.questionId].linksTo),h(this.step.questionId)},this.addAnswer=function(){this.newAnswer.clear(),this.doSearch(),jQuery("#modal").openModal(),jQuery("#modal").find("label").removeClass("active")},this.editAnswer=function(a){this.newAnswer.clear(),this.newAnswer.id=a.id,this.newAnswer.text=a.text,this.newAnswer.linkTo=a.next?a.next:-1,a.next&&(this.newAnswer.search=l.nodes[a.next].text.substr(0,20)),this.doSearch(),jQuery("#modal").openModal(),jQuery("#modal").find("label").addClass("active")},this.selectQuestion=function(a){this.newAnswer.linkTo=a,this.confirmAddAnswer()},this.questionActive=function(a){return a.id===this.newAnswer.linkTo},this.confirmAddAnswer=function(){var a=i();this.newAnswer.id>0&&(a.id=this.newAnswer.id),a.text=this.newAnswer.text,this.newAnswer.linkTo>0&&a.linksTo.push(this.newAnswer.linkTo),l.nodes[a.id]=a,this.newAnswer.id<=0&&l.nodes[this.step.questionId].linksTo.push(a.id),jQuery("#modal").closeModal(),h(this.step.questionId)},this.newQuestion=function(a){var b=j();l.nodes[b.id]=b,l.nodes[a.id].linksTo.push(b.id),a.next=b.id,this.selectAnswer(a)},this.selectAnswer=function(a){this.hasNext()&&m.data.splice(m.current+1,m.data.length-m.current-1),m.current=m.data.length-1,a.next?(h(a.next),m.data.push(this.step),m.current=m.data.length-1):d.info("Нет дальнейшей связи для перехода")},this.quick=function(a){return a.isQuick?"Удалить из быстрых":"Добавить в быстрые"},this.canCreateNew=function(a){return a.next},this.toggleQuick=function(a){a.isQuick?jQuery.each(k.quickLinks,function(b,c){return c.id===a.id?(k.quickLinks.splice(b,1),!1):void 0}):k.quickLinks.push(a),a.isQuick=!a.isQuick};var l={},m={current:-1,data:[]};this.scriptId=1*c.id,this.scriptId?(console.log("script fetching..."),a.findScriptById(this.scriptId,function(a){a.data=JSON.parse(a.script.json_string),l=a,k.scriptName=l.script.script_name,l.nodes={};var c=null;jQuery.each(l.data,function(a,b){l.nodes[b.id]=b,b.startPoint&&(c=b.id),b.quickLink&&k.quickLinks.push(b)}),h(c),m.data.push(k.step),m.current=m.data.length-1,k.isLoading=!1,b.$digest(),console.log()})):console.error("cannot extract necessary params from route"),f.$watchCollection("scriptEditCtrl.quickLinks",function(){setTimeout(function(){jQuery("h5 + div.collection").find("[data-tooltip]").filter(":not([data-tooltip-id])").tooltip({delay:100})},0)})}]),app.controller("ScriptsController",["api","$rootScope","notification","modal",function(a,b,c,d){var e=this;this.loaded=!1,this.dataLoading=!0,this.searchString="",this.scripts=[],this.doSearch=function(){this.dataLoading=!0,this.scripts=a.findScripts(this.searchString,0,function(a){e.scripts=a.scripts,e.dataLoading=!1,b.$digest()}),this.loaded=!0},this.preDelete=function(b){d.okCancelDialog("Вы действительно хотите удалить данный скрипт? Это действие нельзя отменить!",function(){e.dataLoading=!0,a.removeScript(b,function(){e.doSearch(),e.dataLoading=!1},function(){e.dataLoading=!1})},null,"Внимание!")},this.doSearch()}]),app.controller("SupportController",["api","notification",function(a,b){this.topic="",this.message="",this.email=a.getCurrentUser().email,this.send=function(){a.sendTechSupport("Пользователь "+a.getCurrentUser().email+" ("+a.getCurrentUser().getFullName()+") прислал письмо в тех. поддержку.\nEmail: "+this.email+"\nТема: "+this.topic+"\nСообщение: "+this.message)}}]),function(){var a=30,b="http://185.87.49.173:8080/saleman",c=null,d={__store:{},setItem:function(a,b,c){this.__store[a]||(this.__store[a]={}),this.__store[a][b]=c,localStorage.setItem("app_cache",JSON.stringify(this.__store))},getItem:function(a,b){return this.__store[a]&&this.__store[a][b]?this.__store[a][b]:null},getItems:function(b,c,d){if(this.__store[b]){var e=[],f=0,g=!1;c||(c=a),d||(d=0);for(var h in this.__store[b])f++,f>c*d&&(g=!0,f=1),g&&c>=f&&e.push(this.__store[b][h]);return e}return null},removeItem:function(a,b){return this.__store[a]&&this.__store[a][b]?(delete this.__store[a][b],void localStorage.setItem("app_cache",JSON.stringify(this.__store))):null},init:function(){this.__store=localStorage.getItem("app_cache"),this.__store?this.__store=JSON.parse(this.__store):(console.warn("Warning: no data in local storage"),this.__store={})},clear:function(){this.__store={},localStorage.clear()}},e=angular.module("api",["notify"]);e.factory("api",["notification","$rootScope",function(e,f){function g(a){e.info(a.error+" ("+a.error_description+")")}function h(a,d,f,g,h,i){d.url=b+a,c&&(d.url+=(-1!==a.indexOf("?")?"&":"?")+"access_token="+c.accessToken),d.success=function(a){var b=!1;a.code?"1"===a.code?(f&&e.info(f),b=!0):"2"===a.code?e.info("Произошла ошибка при обращении к серверу. Обратитесь в службу технической поддержки"):"3"===a.code?e.info(g?g:"Ошибка проверки данных. Проверьте правильность введеных вами данных"):"4"===a.code&&e.info("У вас нет доступа для совершения этой операции. Обратитесь к администратору вашей системы"):(e.info("Данные подтверждены"),b=!0),b&&h?h(a):!b&&i&&i(a.code,a.message)},d.error=function(){i&&i()},d.dataType="json",d.contentType="application/json",d.data&&d.data.json_string&&(console.log("Encrypting script..."),d.data.json_string=CryptoJS.AES.encrypt(JSON.stringify(d.data.json_string),c.cipherKey).toString()),d.data=JSON.stringify(d.data),d.method||(d.method="POST"),jQuery.ajax(d)}function i(a){a?k=setTimeout(i,1e3*(a-10)):jQuery.ajax({url:b+"/oauth/token?grant_type=refresh_token&client_id=web-client&refresh_token="+c.refreshToken,method:"GET",success:function(a){c.accessToken=a.access_token,c.refreshToken=a.refresh_token,c.expiresIn=a.expires_in,d.setItem("tokens","refresh",a.refresh_token),i(a.expires_in)},error:function(){e.notify("Невозможно соединиться с сервером")}})}function j(a){var b={first_name:a.firstname,last_name:a.lastname,patron:a.patron,email:a.email};return a.password&&a.password.length>0&&(b.password=a.password),a.account_id&&(b.account_id=a.account_id),b}var k=null,l={};return l.register=function(a,b,c){h("/api/auth/register",{data:a},"Регистрация успешно прошла","Проверьте правильность введенных данных",b,"function"==typeof c?c:g)},l.login=function(a,b,e,f,j){h("/oauth/token?grant_type=password&client_id=web-client&password="+b+"&username="+a,{method:"GET"},null,null,function(b){b.error?e&&e(b):(c={email:a,accessToken:b.access_token,refreshToken:b.refresh_token,expiresIn:b.expires_in},d.setItem("tokens","refresh",b.refresh_token),i(20),h("/api/account/getInfo",{data:""},j?null:"Вход успешно выполнен",null,function(a){c.firstname=a.account.firstname,c.lastname=a.account.lastname,c.patron=a.account.patron,c.getFullName=function(){return this.lastname+" "+this.firstname+" "+this.patron},c.perms={},jQuery.each(a.account,function(a,b){var d=a.indexOf("Permission");-1!=d&&(c.perms[a.substring(0,d)]=b)}),c.isAdmin=a.account.admin,c.blocked=a.company.blocked,c.nextPayment=a.account.next_payment;var b=CryptoJS.enc.Utf8.parse(c.email+c.getFullName());c.cipherKey=CryptoJS.enc.Base64.stringify(b),e&&e(a)},g))},"function"==typeof f?f:g)},l.logout=function(a){c=null,clearTimeout(k),e.info("Вы вышли из приложения"),d.clear(),a()},l.isLoggedIn=function(){return null!==l.getCurrentUser()},l.getCurrentUser=function(){return!c&&angular.currentUser&&(c=angular.currentUser,delete angular.currentUser,f.$broadcast("authChange",{})),c},l.sendRecoverEmail=function(a){h("/api/reestablishment/preReestablish?email="+a,{method:"GET"},"На ваш email было выслано сообщение","Проверьте правильность введенных данных")},l.getAllClients=function(b,c){return c||(c=0),h("/api/client/getClients",{data:{search_string:"",count:a,currentPosition:c}},null,null,function(a){a.clients.forEach(function(a,b,c){d.setItem("clients",a.client_id,a)}),b(a)},g),d.getItems("clients",a,c)},l.findClients=function(b,c,e){if(0===b.length)return l.getAllClients(c);e||(e=0),h("/api/client/getClients",{data:{search_string:b,count:a,currentPosition:e}},null,null,function(a){a.clients.forEach(function(a,b,c){d.setItem("clients",a.client_id,a)}),c(a)},g);var f=[],i=null,j=d.getItems("clients");return j&&j.forEach(function(a,c,d){i=a.lastname+" "+a.firstname+" "+a.patron,-1!=i.indexOf(b)&&f.push(a)}),f},l.addClient=function(a,b,e){h("/api/client/createClient",{data:a},e?null:"Клиент сохранен в базу","Неверные данные. Проверьте корректность введенных данных",function(e){a.creator={email:c.email},a.client_id=e.client_id,d.setItem("clients",e.client_id,a),b(d.getItems("clients"))},g)},l.updateClient=function(a,b){d.setItem("clients",a.client_id,a),h("/api/client/updateClient",{data:a},"Клиент сохранен в базу","Неверные данные. Проверьте корректность введенных данных",b,g)},l.removeClient=function(a,b,c){return d.removeItem("clients",a.client_id),c?h("/api/client/removeClient",{data:{client_id:a.client_id}},null,"Невозможно удалить клиента. Обратитесь в службу поддержки",function(){b(),e.infoWithAction("Клиент успешно удален","Отмена",c)},g):h("/api/client/removeClient",{data:{client_id:a.id}},"Клиент успешно удален","Невозможно удалить клиента. Обратитесь в службу поддержки",b,g),d.getItems("clients")},l.findScripts=function(b,c,e){c||(c=0),h("/api/script/getScripts",{data:{string:b,count:a,currentPosition:c?c:0}},null,"Произошла ошибка при выборке. Обратитесь в службу поддержки",function(a){a.scripts.forEach(function(a,b,c){d.setItem("scripts",a.script_id,a)}),e(a)},g);var f=[],i=d.getItems("scripts",a,c);return i&&i.forEach(function(a,c,d){-1!=(a.script_name||a.name).toLowerCase().indexOf(b.toLowerCase())&&f.push(a)}),f},l.findScriptById=function(a,b){h("/api/script/findById",{data:{script_id:a}},null,"Невозможно получить скрипт. Пожалуйста, обратитесь в службу поддержки",function(a){"["===a.script.script.json_string.charAt(0)?(console.log("Using old plain style for script..."),a.script.script.json_string=a.script.script.json_string.replace(/\"/,'"')):(console.log("Decrypting script..."),a.script.script.json_string=CryptoJS.AES.decrypt(a.script.script.json_string,c.cipherKey).toString(CryptoJS.enc.Utf8)),b(a.script)},g)},l.addScript=function(a,b){h("/api/script/createScript",{data:{script_name:a.name,json_string:a.data}},"Скрипт успешно создан","Не удалось создать скрипт. Обратитесь в службу поддержки",function(c){a.script_id=c.script_id,d.setItem("scripts",c.script_id,a),b(c)},g)},l.updateScript=function(a,b){h("/api/script/updateScript",{data:{script_id:a.id||a.script_id||a.script.script_id,script_name:a.name,json_string:a.data}},"Скрипт успешно обновлен","Невозможно обновить скрипт. Пожалуйста, обратитесь в службу поддержки",function(c){d.setItem("scripts",a.script_id,a),b()},g)},l.removeScript=function(a,b,c){d.removeItem("scripts",a),
c?h("/api/script/removeScript",{data:{script_id:a}},null,"Невозможно удалить скрипт. Обратитесь в службу поддержки",function(){b(),e.infoWithAction("Скрипт успешно удален","Отмена",c)},g):h("/api/script/removeScript",{data:{script_id:a}},null,"Невозможно удалить скрипт. Обратитесь в службу поддержки",b,g)},l.sendTechSupport=function(a,b){h("/api/support/support",{data:{message:a}},"Ваш вопрос будет обработан в ближайшее время",null,b,g)},l.createAccount=function(a,b){h("/api/account/createAccount",{data:j(a)},"Аккаунт успешно создан","Неверные данные",function(c){d.setItem("accounts",c.account_id,a),b(c)},g)},l.updateAccount=function(a,b,c){d.setItem("accounts",a.account_id,a),h("/api/account/updateAccount",{data:j(a)},"Аккаунт успешно обновлен","Неверные данные",b,c)},l.removeAccount=function(a,b){d.removeItem("accounts",a),h("/api/account/removeAccount",{data:{account_id:a}},"Аккаунт успешно обновлен","Неверные данные",b,g)},l.findAccounts=function(b,c){return h("/api/account/getManagers",{data:{search_string:"",currentPosition:b&&b>=0?b:0,count:a}},null,null,function(a){a.managers.forEach(function(a,b,c){d.setItem("accounts",a.manager_id,a)}),c(a)},g),d.getItems("accounts")},l.getAccount=function(a,b){h("/api/account/findById",{data:{account_id:a}},"Аккаунт загружен","Неверные данные",b,g)},l.setPermission=function(a,b,c){var d={account_id:a};for(var e in b)d[e]=b[e];h("/api/permission/give",{data:d},"Права доступа применены",null,c,g)},l}]),d.init()}(),function(){var a=angular.module("converter",[]);a.factory("script_converter",function(){var a={convert:function(a,b,c){var d=new FileReader,e={data:[],cache:{},answers:[],name:b};d.onload=function(){var a=jQuery.parseXML(d.result),b=a.querySelectorAll("Pages > Item"),f=0,g=0;jQuery.each(b,function(a,b){var c={};c.id=1*b.getElementsByTagName("Id")[0].innerHTML,0===c.id&&(c.startPoint=!0);var d=b.getElementsByTagName("Text1"),h=b.getElementsByTagName("Text2");c.text=(d.length>0?d[0].innerHTML:"")+"\n"+(h.length>0?h[0].innerHTML:""),c.isAnswer=!1,c.linksTo=[],f=f<=c.id?c.id+1:f;var i=b.querySelectorAll("Answers > Item");jQuery.each(i,function(a,b){var d={};d.id=g++,d.text=b.getElementsByTagName("Text")[0].innerHTML,d.isAnswer=!0;var f=1*b.getElementsByTagName("LinkID")[0].innerHTML;f>=0?d.linksTo=[f]:d.linksTo=[],c.linksTo.push(d.id),e.answers.push(d)}),e.cache[c.id]=c});var h=a.querySelectorAll("QuickLink > Item");jQuery.each(h,function(a,b){var c={id:g++,text:b.getElementsByTagName("Text")[0].innerHTML,isAnswer:!0,linksTo:[1*b.getElementsByTagName("LinkID")[0].innerHTML],quickLink:!0};e.answers.push(c)}),jQuery.each(e.cache,function(a,b){for(var c=0;c<b.linksTo.length;c++)b.linksTo[c]+=f;e.data.push(b)}),jQuery.each(e.answers,function(a,b){b.id+=f,e.data.push(b)}),"function"==typeof c?c({name:e.name,data:e.data}):console.error("Callback is not a function")},d.readAsText(a)}};return a})}();var saleman_misc={removeElement:function(a,b){for(var c=0;c<b.length;c++)a===b[c]&&b.splice(c,1)},findFirstNotNullElement:function(a){for(var b=0;b<a.length;b++)if(null!=a[b])return a[b]},copyObj:function(a){var b={};for(var c in a)b[c]=a[c];return b}},ModelConfig={email:function(a){return{type:"string",regexp:/.+@[a-z]+\.[a-z]+/,required:a,err:"Пример: qwe@gmail.com"}},password:function(a){return{type:"string",min:6,required:a,err:"Минимум 6 символов"}},password_retype:function(a,b){return{type:"string",eq:a,required:b,err:"Пароли не совпадают"}},firstName:function(a){return{type:"string",min:1,required:a,err:"Обязательное"}},lastName:function(a){return{type:"string",min:1,required:a,err:"Обязательное"}},patron:function(a){return{type:"string",min:1,required:a,err:"Обязательное"}},companyName:function(a){return{type:"string",min:1,required:a,err:"Обязательное"}},description:function(a){return{type:"string",required:a,err:"Обязательное"}},phone:function(a){return{type:"string",regexp:/(\+7|7|8){0,1}[ -]?\d{3}[ -]?\d{3}[ -]?\d{2}[ -]?\d{2}/,required:a,err:"Пример: 8 900 123 34 45"}},website:function(a){return{type:"string",min:3,required:a}}},Models={client:function(a){var b={firstname:ModelConfig.firstName(!0),lastname:ModelConfig.lastName(!1),patron:ModelConfig.patron(!1),phone:ModelConfig.phone(!1),email:ModelConfig.email(!1)};return overrideLogic(b,a),b}};!function(){app.controller("NavbarController",["api","$rootScope","notification","$location",function(a,b,c,d){var e=this;this.username="initial",this.currentMenu=null,this.loggedIn=a.isLoggedIn(),this.logout=function(){a.logout(function(a){c.info("Вы вышли из приложения"),f=null,b.$broadcast("authChange",{})})},this.selectMenuItem=function(a){f=a},this.menuSelected=function(a){return f===a};var f=null,g={manager:[{name:"Скрипты",location:"#/scripts",showBlocked:!1},{name:"База клиентов",location:"#/clients",showBlocked:!1},{name:"Задачи",location:"#/notready",showBlocked:!1},{name:"Тех. поддержка",location:"#/support",showBlocked:!0},{name:"Импорт",location:"#/convert",showBlocked:!1}],admin:[{name:"Скрипты",location:"#/scripts",showBlocked:!1},{name:"База клиентов",location:"#/clients",showBlocked:!1},{name:"Задачи",location:"#/notready",showBlocked:!1},{name:"Тех. поддержка",location:"#/support",showBlocked:!0},{name:"Статистика",location:"#/notready",showBlocked:!1},{name:"Импорт",location:"#/convert",showBlocked:!1},{name:"Аккаунты",location:"#/accounts",showBlocked:!0}],"system-admin":[{name:"Цены",location:"/#/home"},{name:"Статистика использования",location:"/#/home"},{name:"Сообщения",location:"/#/home"},{name:"Настройки приложения",location:"/#/home"}]};b.$on("authChange",function(){if(e.loggedIn=a.isLoggedIn(),e.username=e.loggedIn?a.getCurrentUser().getFullName():"",e.currentMenu=a.getCurrentUser().isAdmin?g.admin:g.manager,a.getCurrentUser().blocked)for(var c=0;c<e.currentMenu.length;c++)void 0!==e.currentMenu[c].showBlocked&&e.currentMenu[c]===!1&&e.currentMenu.splice(c,1);var h=d.path();if(-1!==h.indexOf("login"))d.path("/scripts"),f=e.currentMenu[0];else for(var c=0;c<e.currentMenu.length;c++)if(-1!==e.currentMenu[c].location.indexOf(h)){f=e.currentMenu[c];break}b.$digest(),d.path("/scripts")})}])}(),function(){function a(){var a=jQuery("#"+g);return 0===a.length?b():a}function b(){var a=jQuery('<div id="'+g+'" class="modal modal-fixed-footer"><div class="modal-content"><h4 id="'+g+'Header">MODAL HEADER</h4><span id="'+g+'Body">BODY</span></div><div class="modal-footer" id="'+g+'Footer"></div></div>');return jQuery(document.body).append(a),a}function c(a,b){a.find("#"+g+"Header").html("").html(b)}function d(a,b){a.find("#"+g+"Body").html("").html(b)}function e(a,b){a.find("#"+g+"Footer").html(""),jQuery.each(b,function(b,c){jQuery('<a id="button'+b+'" class="btn modal-action modal-close">'+c.text+"</a>").appendTo(a.find("#"+g+"Footer")).click(c.callback)})}var f=4e3,g="notifyModal",h="Внимание",i="OK",j="Отмена",k=0,l={},m=angular.module("notify",[]);m.factory("notification",function(){var a={info:function(a){l[a]||(l[a]=!0,Materialize.toast(a,f,"",function(){delete l[a]}))},infoWithAction:function(a,b,c){var d=Materialize.toast("<span>"+a+'</span><a class="btn-flat yellow-text" id="not'+k+'">'+b+"</a>",f);jQuery("#not"+k++).click(function(){c(),d()})}};return a}),m.factory("modal",function(){var b={info:function(b,f){var g=a();d(g,b),f?c(g,f):c(g,h),e(g,[{text:i,callback:jQuery.noop}]),g.openModal()},okCancelDialog:function(b,f,g,h,k,l){var m=a(),n=[{text:k?k:i,callback:f?f:jQuery.noop},{text:l?l:j,callback:g?g:jQuery.noop}];d(m,b),h&&c(m,h),e(m,n),m.openModal()}};return b})}();