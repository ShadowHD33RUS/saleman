<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0"/>

  <!-- Turn off cache in all browsers -->
  <!--<meta http-equiv="cache-control" content="max-age=0" />
  <meta http-equiv="cache-control" content="no-cache" />
  <meta http-equiv="expires" content="0" />
  <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
  <meta http-equiv="pragma" content="no-cache" />-->

  <title>Скрипты продаж Saleman</title>
  <link rel="stylesheet" href="assets/css/materialize.css" media="screen" title="no title" charset="utf-8">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/style.css" media="screen" title="no title" charset="utf-8">
</head>
<body>

  <div class="centered" id="appPreloader">
    <div class="centered" style="width:64px">
      <div class="preloader-wrapper big active">
        <div class="spinner-layer spinner-blue-only">
          <div class="circle-clipper left">
            <div class="circle"></div>
          </div><div class="gap-patch">
            <div class="circle"></div>
          </div><div class="circle-clipper right">
            <div class="circle"></div>
          </div>
        </div>
      </div>
    </div>
    <span class="preloaderText">Загрузка приложения</span>
  </div>



  <nav ng-controller="NavbarController as navbar" ng-show="navbar.loggedIn" id="hiden" class="blue darken-1">
    <div class="nav-wrapper">
      <a href="/dialogs" class="brand-logo">{{navbar.username}}</a>
      <a href="" data-activates="nav-mobile" class="button-collapse"><i class="material-icons">menu</i></a>
      <ul class="right hide-on-med-and-down">
        <li ng-repeat="item in navbar.currentMenu" ng-click="navbar.selectMenuItem(item)" ng-class="{active: navbar.menuSelected(item)}"><a href="{{item.location}}">{{item.name}}</a></li>
        <li><a href="/#/home" ng-click="navbar.logout()">Выйти</a></li>
      </ul>
      <ul id="nav-mobile" class="side-nav">
        <li ng-repeat="item in navbar.currentMenu" ng-click="navbar.selectMenuItem(item)" ng-class="{active: navbar.menuSelected(item)}"><a href="{{item.location}}">{{item.name}}</a></li>
        <li><a href="/#/home" ng-click="navbar.logout()">Выйти</a></li>
      </ul>
    </div>
  </nav>

  <div class="container" ng-view>

  </div>
  <script src="assets/js/jquery-2.1.4.min.js" charset="utf-8"></script>
  <script src="assets/js/materialize.js" charset="utf-8"></script>
  <script src="assets/js/toast.js" charset="utf-8"></script>
  <script src="assets/js/angular.min.js" charset="utf-8"></script>
  <script src="assets/js/angular-route.min.js" charset="utf-8"></script>
  <script type="text/javascript" src="assets/js/fabric.min.js"></script>
  <script src="assets/js/treelib.js" charset="utf-8"></script>

  <!-- General modules -->
  <script src="app/app.module.js" charset="utf-8"></script>
  <script src="app/app.route.js" charset="utf-8"></script>
  <script src="app/share/api/apiService.js" charset="utf-8"></script>
  <script src="app/share/navbar/navbarController.js" charset="utf-8"></script>
  <script src="app/share/notify/notifyService.js" charset="utf-8"></script>
  <script src="app/share/model/model.js" charset="utf-8"></script>

  <!-- Components -->
  <script src="app/components/clients/clientsController.js" charset="utf-8"></script>
  <script src="app/components/login/loginController.js" charset="utf-8"></script>
  <script src="app/components/registration/registrationController.js" charset="utf-8"></script>
  <script src="app/components/script_editor/scripteditorController.js" charset="utf-8"></script>
  <script src="app/components/script_run/scriptrunController.js" charset="utf-8"></script>
  <script src="app/components/scripts/scriptsController.js" charset="utf-8"></script>
  <script src="app/components/support/supportController.js" charset="utf-8"></script>
  <script src="app/components/convert/convertController.js" charset="utf-8"></script>
  <script src="app/components/accounts/accountsController.js" charset="utf-8"></script>
  <script src="app/components/recover/recoverController.js" charset="utf-8"></script>
  <script type="text/javascript">
    function loadApplication() {
      angular.bootstrap(document.body, ['saleman']);
      $('#appPreloader').css('display', 'none');
      $('#hiden').css('display', 'block');
    }
    
    jQuery(document).ready(function(){
      jQuery(".button-collapse").sideNav();
      // jQuery("#hiden").css('display', 'block');
      var appCache = localStorage.getItem('app_cache');
      if(appCache) {
        appCache = JSON.parse(appCache);
        if(appCache['tokens'] && appCache['tokens']['refresh']) {
          //We have some refresh token here
          $.ajax({
            url: 'http://185.87.49.173:8080/saleman/oauth/token?grant_type=refresh_token&client_id=web-client&refresh_token='+appCache['tokens']['refresh'],
            dataType: 'json',
            contentType: 'application/json',
            success: function(data) {
              var currentUser = {
                accessToken: data.access_token,
                refreshToken: data.refresh_token,
                expiresIn: data.expires_in,
              };
              $.ajax({
                url: 'http://185.87.49.173:8080/saleman/api/account/getInfo?access_token='+data.access_token,
                dataType: 'json',
                method: 'POST',
                contentType: 'application/json',
                success: function(data) {
                  currentUser.email = data.account.email,
                  currentUser.firstname = data.account.firstname;
                  currentUser.lastname = data.account.lastname;
                  currentUser.patron = data.account.patron;
                  currentUser.getFullName = function() {
                      return this.lastname + ' ' + this.firstname + ' ' + this.patron;
                  };
                  //Parse permissions
                  currentUser.perms = {};
                  $.each(data.account, function(k,v){
                      var delim = k.indexOf('Permission');
                      if(delim != -1) {
                          currentUser.perms[k.substring(0, delim)] = v;
                      }
                  });
                  currentUser.isAdmin = data.account.admin;
                  currentUser.blocked = data.company.blocked;
                  currentUser.nextPayment = data.account.next_payment;
                  angular.currentUser = currentUser;
                  loadApplication();
                },
                error: function() {
                  loadApplication();
                }
              });
            },
            error: function() {
              loadApplication();
            }
          })
        } else {
          loadApplication();
        }
      } else {
        loadApplication();
      }
      
    });
  </script>
</body>
</html>
