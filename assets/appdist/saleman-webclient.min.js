/*! saleman-webclient 2015-10-05 */
function Model(a){var b=this,c={};for(var d in a)a[d]&&a[d].type?(c[d]={},"string"===a[d].type?this[d]={data:a[d].initial?a[d].initial:"",valid:!0}:"number"===a[d].type?this[d]={data:a[d].initial?a[d].initial:0,valid:!0}:"date"===a[d].type&&(this[d]={data:a[d].initial?a[d].initial:new Date,valid:!0})):this[d]={data:"",valid:!0};this.validate=function(){var b=!0;for(var c in a)this[c].valid=!0,a[c].required||this[c].data.length>0?(a[c].eq&&this[c].data!==this[a[c].eq].data?(this[c].valid=!1,this[c].cause="eq",this[c].msg=a[c].err?a[c].err:"This field must be equal to "+c):"string"===a[c].type?a[c].regexp?a[c].regexp.test(this[c].data)||(this[c].valid=!1,this[c].cause="regexp",this[c].msg=a[c].err?a[c].err:"Regexp is not matching"):(a[c].min&&this[c].data.length<a[c].min&&(this[c].valid=!1,this[c].cause="short",this[c].msg=a[c].err?a[c].err:"too short. min - "+(a[c].min-1)),a[c].max&&this[c].data.length>a[c].max&&(this[c].valid=!1,this[c].cause="long",this[c].msg=a[c].err?a[c].err:"too long. max - "+(a[c].max+1))):"number"===a[c].type&&(a[c].min&&this[c].data<a[c].min&&(this[c].valid=!1,this[c].cause="short",this[c].msg=a[c].err?a[c].err:"Number must be greater than "+(a[c].min-1)),a[c].max&&this[c].data>a[c].max&&(this[c].valid=!1,this[c].cause="long",this[c].msg=a[c].err?a[c].err:"Number must be less than "+(a[c].max+1))),b&=this[c].valid):this[c].valid=!0;return this.valid=b,this.valid},this.toJson=function(c){var d={};return jQuery.each(a,function(a,e){c&&null!=c[a]||(d[a]=b[a].data)}),d},this.clearData=function(){jQuery.each(a,function(a,c){"string"===c.type?b[a].data="":"number"===c.type&&(b[a].data=0)})},this.populate=function(c){for(var d in a)c[d]&&(typeof c[d]).toLowerCase()===a[d].type&&(b[d].data=c[d])}}function overrideLogic(a,b){for(var c in a)b[c]&&"Object"==typeof b[c]&&(a[c]=b[c])}var app=angular.module("saleman",["ngRoute","api","notify"]);app.directive("viewDropdown",function(){return function(a,b,c){a.$last&&jQuery(".dropdown-button").dropdown({inDuration:300,outDuration:225,constrain_width:!1,hover:!0,gutter:0,belowOrigin:!1})}}),app.run(["$rootScope","$location","api","notification",function(a,b,c,d){a.$on("$routeChangeStart",function(a,e,f){if(c.isLoggedIn()||"app/components/login/login.html"===e.templateUrl||"app/components/registration/registration.html"===e.templateUrl||"app/components/recover/recover.html"===e.templateUrl){var g=e.templateUrl.substring(15,e.templateUrl.indexOf("/",15));c.isLoggedIn()&&c.getCurrentUser().blocked&&("payment"!==g||"accounts"!==g||"clients"!==g)&&(d.info("Ваш аккаунт заблокирован"),d.info("Пожалуйста, оплатите для дальнейшего пользования"),b.path("/payment"))}else d.info("Необходимо войти в систему"),b.path("/login")})}]),app.config(["$routeProvider",function(a){a.when("/login",{templateUrl:"app/components/login/login.html",controller:"LoginController",controllerAs:"loginCtrl"}).when("/register",{templateUrl:"app/components/registration/registration.html",controller:"RegistrationController",controllerAs:"regCtrl"}).when("/clients",{templateUrl:"app/components/clients/clients.html",controller:"ClientsController",controllerAs:"clientsCtrl"}).when("/scripts",{templateUrl:"app/components/scripts/scripts.html",controller:"ScriptsController",controllerAs:"scriptsCtrl"}).when("/scripttree/:scriptId",{templateUrl:"app/components/script_editor/script_editor.html",controller:"ScriptEditorController",controllerAs:"editorCtrl"}).when("/scriptrun/:scriptId",{templateUrl:"app/components/script_run/scriptrun.html",controller:"ScriptRunController",controllerAs:"scriptRunCtrl"}).when("/support",{templateUrl:"app/components/support/support.html",controller:"SupportController",controllerAs:"supportCtrl"}).when("/convert",{templateUrl:"app/components/convert/convert.html",controller:"ConvertController",controllerAs:"convertCtrl"}).when("/accounts",{templateUrl:"app/components/accounts/accounts.html",controller:"AccountsController",controllerAs:"accountsCtrl"}).when("/recover",{templateUrl:"app/components/recover/recover.html",controller:"RecoverController",controllerAs:"recoverCtrl"}).when("/notready",{templateUrl:"app/components/notready/notready.html"}).when("/scripttextedit/:id",{templateUrl:"app/components/script_texteditor/script_texteditor.html",controller:"ScriptTextEditorController",controllerAs:"scriptEditCtrl"}).when("/scripttextedit/:id/:nodeId",{templateUrl:"app/components/script_texteditor/script_texteditor.html",controller:"ScriptTextEditorController",controllerAs:"scriptEditCtrl"}).otherwise({redirectTo:"/login"})}]),app.controller("AccountsController",["api","notification","$rootScope",function(a,b,c){var d=this;this.model=new Model({account_id:{type:"number"},first_name:ModelConfig.firstName(!0),last_name:ModelConfig.lastName(!1),patron:ModelConfig.patron(!1),email:ModelConfig.email(!0),password:ModelConfig.password(!1)}),this.perms={scriptReadPermission:!1,scriptEditPermission:!1,clientReadPermission:!1,clientEditPermission:!1},this.searchString="",this.accounts=[],this.filteredAccounts=[],this.save=function(){e(!1),this.model.manager_id?a.updateAccount(this.model.toJson(),function(b){"1"!==b.code?e(!0):a.setPermission(d.model.manager_id,d.perms,function(){e(!0)})},function(){e(!0)}):a.createAccount(this.model.toJson(),function(b){"1"!==b.code?e(!0):a.setPermission(b.account_id,d.perms,function(){e(!0)})})},this.createNew=function(){this.model.clearData(),jQuery("#editor").find("label").removeClass("active"),e(!0)},this.selectAccount=function(b){e(!1),this.model.manager_id=b.manager_id,this.model.populate(b),a.getAccount(b.manager_id,function(a){d.model.populate(a.account.account);for(var b in d.perms)d.perms[b]=a.account.account[b];e(!0),c.$digest()})},this.doSearch=function(){d.filteredAccounts=[],jQuery.each(d.accounts,function(a,b){-1!==b.email.toLowerCase().indexOf(d.searchString.toLowerCase())&&d.filteredAccounts.push(b)})},this.isActive=function(a){return a===this.currentAccount};var e=function(a){a?(jQuery("#editor").find("input").removeAttr("disabled"),jQuery("#editor").find("label").addClass("active"),jQuery("#editor").find("a.btn").removeClass("disabled")):(jQuery("#editor").find("input").attr("disabled","true"),jQuery("#editor").find("a.btn").addClass("disabled"))};e(!1),d.filteredAccounts=a.findAccounts(0,function(a){d.accounts=a.managers,d.filteredAccounts=d.accounts,c.$digest()}),d.accounts=d.filteredAccounts}]),app.controller("ClientsController",["api","$rootScope","modal","notification",function(a,b,c,d){var e=this;e.loaded=!1,e.dataLoading=!1,e.clients=[],e.searchString="",e.currentClient={},e.clientModel=new Model({email:ModelConfig.email(!1),firstname:ModelConfig.firstName(!0),lastname:ModelConfig.lastName(!1),patron:ModelConfig.patron(!1),phone:ModelConfig.phone(!1)}),this.doSearch=function(){e.dataLoading=!0,e.searchString.length>0?e.clients=a.findClients(e.searchString,function(a){e.clients=a.clients,e.dataLoading=!1,e.loaded||(e.loaded=!0),b.$digest()}):e.clients=a.getAllClients(function(a){e.clients=a.clients,e.dataLoading=!1,e.loaded||(e.loaded=!0),b.$digest()}),e.clients&&(e.loaded=!0)},this.edit=function(a){for(var b in a)e.clientModel[b]&&(e.clientModel[b].data=a[b]);e.clientModel.client_id=a.client_id,jQuery("#clientModal").openModal()},this.save=function(){e.clientModel.validate(),e.clientModel.valid?(jQuery("#clientModal").closeModal(),this.dataLoading=!0,e.clientModel.client_id?a.updateClient(e.clientModel.toJson([]),function(){e.dataLoading=!1}):a.addClient(e.clientModel.toJson([]),function(a){e.clients=a,e.dataLoading=!1,b.$digest()})):d.info("Исправьте данные")},this.create=function(){e.clientModel.clearData(),delete e.clientModel.client_id,jQuery("#clientModal").openModal()},this.remove=function(d){var f=d;c.okCancelDialog("Вы уверены, что хотите удалить клиента?",function(){e.dataLoading=!0,b.$digest(),e.clients=a.removeClient(f,function(){e.doSearch()},function(){e.dataLoading=!0,f.id=void 0,a.addClient(f,function(){e.doSearch()},!0)})},null,"Внимание")},this.doSearch()}]),app.controller("ConvertController",["api","notification",function(a,b){this.apiSupport=!1,window.File&&window.FileReader?this.apiSupport=!0:b.info("Импорт не будет работать. Обновите ваш браузер"),this.importScript=function(){for(var c=jQuery("#oldFile")[0],d=0;d<c.files.length;d++){var e=new FileReader,f={data:[],cache:{},answers:[],name:jQuery("#oldFile").parent().parent().find('input[type="text"]').val().substr(0,20)};e.onload=function(){var c=jQuery.parseXML(e.result),d=c.querySelectorAll("Pages > Item"),g=0,h=0;jQuery.each(d,function(a,b){var c={};c.id=1*b.getElementsByTagName("Id")[0].innerHTML,0===c.id&&(c.startPoint=!0);var d=b.getElementsByTagName("Text1"),e=b.getElementsByTagName("Text2");c.text=(d.length>0?d[0].innerHTML:"")+"\n"+(e.length>0?e[0].innerHTML:""),c.isAnswer=!1,c.linksTo=[],g=g<=c.id?c.id+1:g;var i=b.querySelectorAll("Answers > Item");jQuery.each(i,function(a,b){var d={};d.id=h++,d.text=b.getElementsByTagName("Text")[0].innerHTML,d.isAnswer=!0;var e=1*b.getElementsByTagName("LinkID")[0].innerHTML;e>=0?d.linksTo=[e]:d.linksTo=[],c.linksTo.push(d.id),f.answers.push(d)}),f.cache[c.id]=c});var i=c.querySelectorAll("QuickLink > Item");jQuery.each(i,function(a,b){var c={id:h++,text:b.getElementsByTagName("Text")[0].innerHTML,isAnswer:!0,linksTo:[1*b.getElementsByTagName("LinkID")[0].innerHTML],quickLink:!0};f.answers.push(c)}),jQuery.each(f.cache,function(a,b){for(var c=0;c<b.linksTo.length;c++)b.linksTo[c]+=g;f.data.push(b)}),jQuery.each(f.answers,function(a,b){b.id+=g,f.data.push(b)}),a.addScript(f,function(a){"1"===a.code&&b.info("Скрипт импортирован")})},e.readAsText(c.files[d])}}}]),app.controller("LoginController",["$location","api","$scope","$rootScope","$timeout","notification",function(a,b,c,d,e,f){this.model=new Model({login:ModelConfig.email(!0),password:ModelConfig.password(!0)}),this.validate=function(){this.model.validate()},this.doLogin=function(){void 0===this.model.valid&&this.model.validate(),this.model.valid?($("#sendButton").addClass("disabled"),b.login(this.model.login.data,this.model.password.data,function(b){b.error?(f.info("Неверная пара логин/пароль"),$("#sendButton").removeClass("disabled")):($("#sendButton").removeClass("disabled"),a.path("/dialogs"),c.$digest(),d.$broadcast("authChange",{}))},function(a){f.info("Ошибка сервера"),$("#sendButton").removeClass("disabled")})):f.info("Исправьте поля с красным цветом")}}]),app.controller("RecoverController",["$location","api","$scope","$rootScope","$timeout","notification",function(a,b,c,d,e,f){this.model=new Model({email:ModelConfig.email(!0)}),this.validate=function(){this.model.validate()},this.doRecover=function(){void 0===this.model.valid&&this.model.validate(),this.model.valid?($("#sendButton").addClass("disabled"),b.sendRecoverEmail(this.model.email.data)):f.info("Исправьте поля с красным цветом")}}]),app.controller("RegistrationController",["$location","api","$scope","notification",function(a,b,c,d){this.user=new Model({email:ModelConfig.email(!0),password:ModelConfig.password(!0),password2:ModelConfig.password_retype("password",!0),first_name:ModelConfig.firstName(!0),last_name:ModelConfig.lastName(!0),patron:ModelConfig.patron(!0)}),this.user.validate(),this.register=function(){if(this.user.valid){$("#sendButton").addClass("disabled");var e=this.user.toJson(["password2"]);b.register(e,function(){$("#sendButton").addClass("disabled"),d.info("Вы успешно зарегистрировались. Теперь можете войти в систему"),a.path("/login"),c.$apply()},function(a){$("#sendButton").removeClass("disabled"),d.info("Сервер ответил ошибкой")})}else d.info("Исправьте поля с красным цветом")}}]),app.controller("ScriptEditorController",["$rootScope","$routeParams","api","notification","modal","$location",function(a,b,c,d,e,f){this.scriptName="",this.isLoading=!0,this.quickLinks=[],this.removeQuickLink=function(b){var c=[];jQuery.each(this.quickLinks,function(a,d){b!=d&&c.push(d)}),this.quickLinks=c,a.$digest()};var g=function(a){for(var b=0;b<a.length;b++)if(a[b])return!1;return!0},h=this,i=jQuery('<canvas id="canv" width="'+jQuery("#treelib-holder").width()+'" height="500"></canvas>');jQuery("#treelib-holder").append(i);var j=new fabric.Canvas("canv",{selection:!1,hoverCursor:"pointer"}),k=new treelib.Diagram(j),l=null,m=!1,n=null;if("0"!=b.scriptId&&(n=1*b.scriptId),n)c.findScriptById(n,function(b){b.data=JSON.parse(b.script.json_string),l=b,k.loadFromJson(l.data),k.init(),h.quickLinks=k.getQuickLinks(),h.scriptName=l.script.script_name,h.isLoading=!1,a.$digest()}),this.scriptId=n;else{h.isLoading=!1;var l={name:"Новый скрипт",data:[{id:1,text:"Точка входа",isAnswer:!1,startPoint:!0,linksTo:[2,3]},{id:2,text:"Вариант ответа 1",isAnswer:!0,linksTo:[4]},{id:3,text:"Вариант ответа 2",isAnswer:!0,linksTo:[4]},{id:4,text:"Выход из скрипта",isAnswer:!1,linksTo:[]}]};k.loadFromJson(l.data),k.init(),k.buildTree(),h.quickLinks=k.getQuickLinks(),m=!0,h.scriptName=l.name}var o=null,p=!1,q=null,r=new fabric.Point(0,0),s=new fabric.Point(0,0),t=function(a){a=a||window.event;var b=a.deltaY||a.detail||a.wheelDelta;a.preventDefault(),0>b?(j.zoomToPoint(s,1.1*j.getZoom()),r.x*=1.1,r.y*=1.1):(j.zoomToPoint(s,j.getZoom()/1.1),r.x*=1.1,r.y*=1.1)},u=function(){f.path("/scripttextedit/"+h.scriptId),a.$digest()};this.switchToTextMode=function(){jQuery("#saveScript").click(),this.scriptId>=0&&(f.path("/scripttextedit/"+h.scriptId),a.$digest())},j.on("mouse:down",function(a){var b=jQuery("#textEditor");if(a.target){if(a.target.treelib_type===treelib.NODE)if(a.e.shiftKey&&null!=o){var c=k.connect(o.treelib_model,a.target.treelib_model);1===c?e.info("Нельзя соединить уже соединенные объекты","Ошибка"):2===c?e.info("Объекты одного типа нельзя соединять - вопросы с ответами, ответы с вопросами","Ошибка"):3===c&&e.info("Узел уже ссылается на другой скрипт","Ошибка")}else b.removeAttr("disabled"),b.val(a.target.treelib_model.getText());o=a.target}else b.attr("disabled",""),b.val(""),p=!0,o=null}),j.on("mouse:move",function(a){if(!p){var b=j.getPointer(a.e);s.x=b.x,s.y=b.y}}),jQuery("#treelib-holder")[0].addEventListener?"onwheel"in document?jQuery("#treelib-holder")[0].addEventListener("wheel",t):"onmousewheel"in document?jQuery("#treelib-holder")[0].addEventListener("mousewheel",t):jQuery("#treelib-holder")[0].addEventListener("MozMousePixelScroll",t):jQuery("#treelib-holder")[0].attachEvent("onmousewheel",t),jQuery(window).mouseup(function(){p=!1,q=null}),jQuery(window).mousemove(function(a){p&&(null!==q&&(r.x=a.pageX-q[0],r.y=a.pageY-q[1],j.relativePan(r)),q=[a.pageX,a.pageY])}),jQuery("#textEditor").keyup(function(){o&&o.treelib_model.setText(jQuery("#textEditor").val())}),jQuery(window).keydown(function(a){o&&46===a.keyCode&&(k.remove(o.treelib_model)||e.info("В дереве скрипта должен оставаться хотя бы один вопрос","Ошибка"),o=null)}),jQuery("#buildTree").click(function(){o&&o.treelib_type===treelib.NODE?k.buildTree(o.treelib_model.id):k.buildTree()}),jQuery("#addNew").click(function(a){if(a.preventDefault(),o&&o.treelib_type===treelib.NODE)if(!o.treelib_model.isAnswer||g(o.treelib_model.children))if(o.treelib_model.nextScript)e.info("Выбранный объект ссылается на другой скрипт","Ошибка");else{var b=new treelib.Node({id:k.generateId(),text:"Новый элемент",isAnswer:!o.treelib_model.isAnswer,linksTo:[]});k.add(b),k.connect(o.treelib_model,b),k.buildTree(o.treelib_model.id)}else e.info("У объекта типа 'ответ' может быть только одна выходная стрелка","Ошибка");else e.info("Для создания нового объекта необходимо выбрать какой-либо из уже существующих на диаграмме","Ошибка")}),jQuery("#saveScript").click(function(a){l.data=k.saveToJson(),l.name=h.scriptName,console.log(a),m?c.addScript(l,function(a){l.id=a.script_id,h.scriptId=a.script_id,u(),m=!1}):c.updateScript(l,function(){})}),jQuery("#addToFast").click(function(){o&&o.treelib_type===treelib.NODE?o.treelib_model.setQuickLink(!0)?(h.quickLinks.push(o.treelib_model),a.$digest()):e.info("Нужно выбрать узел с ответом клиента, а не с вопросом менеджера","Ошибка"):e.info("Необходимо выбрать узел","Ошибка")}),jQuery("#transition").click(function(){d.info("Простите, данная функция временно не поддерживается")})}]),app.controller("ScriptRunController",["api","$rootScope","$routeParams","notification","modal",function(a,b,c,d,e){this.ready=!1,this.nodes={},this.isLoading=!0;var f={current:0,data:[]},g=new Model(Models.client({}));this.manager={name:a.getCurrentUser().firstname},this.client={name:"",phone:"",address:""},this.step={questionId:-1,question:"Загрузка...",answers:[]},this.quickLinks=[];var h=function(a){var b=null;return jQuery.each(a,function(a,c){return c?(b=c,!1):void 0}),b},i=this,j=c.scriptId,k=function(a){for(var b="",c=a.indexOf("(("),d=0;-1!=c;){b+=a.substring(d,c);var e=a.indexOf("))",c),f=a.substring(c+2,e),g=f.split(".");if(2===g.length&&("manager"===g[0]?"name"===g[1]&&(b+=i.manager.name):"client"===g[0]&&"name"===g[1]&&(b+=i.client.name)),d=e+2,c=a.indexOf("((",d),-1===c){b+=a.substr(d);break}}return b.trim().length>0?b:a},l=function(a){i.step.questionId=a,i.step.question=k(i.nodes[a].text),i.step.answers=[],jQuery.each(i.nodes[a].linksTo,function(a,b){if(b){var c=h(i.nodes[b].linksTo);i.step.answers.push({text:i.nodes[b].text,next:c?c:!1})}})};j&&(j=1*j),a.findScriptById(j,function(a){a.data=JSON.parse(a.script.json_string),i.script=a;var c=null;jQuery.each(a.data,function(a,b){i.nodes[b.id]=b,b.startPoint&&(c=b.id),b.quickLink&&i.quickLinks.push(b)}),l(c),f.data.push(m(i.step)),f.current=f.data.length-1,i.isLoading=!1,b.$digest()}),this.selectAnswer=function(a){this.hasNext()&&f.data.splice(f.current+1,f.data.length-f.current-1),f.current=f.data.length-1,a.next?(l(a.next),0===this.step.answers.length&&(this.step.answers=[{text:"Завершить выполнение скрипта"}]),f.data.push(m(this.step)),f.current=f.data.length-1):(this.step.question="Выполнение скрипта завершено",this.step.answers=[],f.current++)},this.hasNext=function(){return f.data.length>f.current+1?!0:!1},this.hasPrev=function(){return f.data[f.current-1]?!0:!1},this.next=function(){if(this.hasNext()){var a=f.data[++f.current];l(a.questionId)}},this.prev=function(){if(this.hasPrev()){var a=f.data[--f.current];l(a.questionId)}},this.setQuickLink=function(a){l(h(this.nodes[a].linksTo)),f.data.push(m(this.step)),f.current=f.data.length-1},this.saveClient=function(){var b=this.client.name.trim().split(" ");1==b.length?g.firstname.data=b[0]:2==b.length?(g.firstname.data=b[0],g.patron.data=b[1]):3==b.length?(g.lastname.data=b[0],g.firstname.data=b[1],g.patron.data=b[2]):e.info('В поле "Имя клиента" должно быть либо имя, либо имя-отчество, либо фамилия-имя-отчество'),g.phone.data=this.client.phone,g.email.data=this.client.address,g.validate(),g.valid?a.addClient(g.toJson()):d.info("Данные в форме неверны")};var m=function(a){var b={};for(var c in a)b[c]=a[c];return b}}]),app.controller("ScriptTextEditorController",["api","$rootScope","$routeParams","notification","modal","$scope","$location",function(a,b,c,d,e,f,g){this.isLoading=!1,this.quickLinks=[],this.step={questionId:-1,question:"",answers:[]},this.scriptId=-1,this.newAnswer={id:-1,text:"Новый ответ",linkTo:-1,filtered:[],search:"",clear:function(){this.text="Новый ответ",this.linkTo=-1,this.filtered=[],this.search="",this.id=-1}},this.scriptName="123";var h={},i={current:-1,data:[]},j=function(a){var b=h.nodes[a],c={questionId:a,question:b.text,answers:[]};jQuery.each(b.linksTo,function(a,b){if(b&&h.nodes[b]){var d=h.nodes[b],e=m(d.linksTo);c.answers.push({id:d.id,text:d.text,next:e?e:!1})}}),o.step.questionId>0&&(h.nodes[o.step.questionId].text=o.step.question,jQuery.each(o.step.answers,function(a,b){h.nodes[b.id].text=b.text})),o.step=c,setTimeout(function(){jQuery(".dropdown-button").dropdown({inDuration:300,outDuration:225,constrain_width:!1,hover:!1,gutter:0,belowOrigin:!1,alignment:"left"}),jQuery("[data-tooltip]").filter(":not([data-tooltip-id])").tooltip({delay:100})},0)},k=function(){var a,b=-1;for(var c in h.nodes)c=parseInt(c),c>b&&(b=c);return a={id:b+1,isAnswer:!0,linksTo:[],quickLink:!1,startPoint:!1,text:"Новый ответ"}},l=function(){var a=k();return a.text="Новый вопрос",a.isAnswer=!1,a};this.hasNext=function(){return i.data.length>i.current+1?!0:!1},this.hasPrev=function(){return i.data[i.current-1]?!0:!1},this.next=function(){if(this.hasNext()){var a=i.data[++i.current];j(a.questionId)}},this.prev=function(){if(this.hasPrev()){var a=i.data[--i.current];j(a.questionId)}},this.doSearch=function(){var a=[],b=this.newAnswer.search;for(var c in h.nodes)h.nodes[c]&&!h.nodes[c].isAnswer&&-1!==h.nodes[c].text.toLowerCase().indexOf(b.toLowerCase())&&a.push(h.nodes[c]);this.newAnswer.filtered=a},this.saveScript=function(b){var c={data:[],name:""};jQuery.each(h.nodes,function(a,b){c.data.push(b)}),c.name=this.scriptName,o.scriptId?(c.id=o.scriptId,a.updateScript(c,function(){b(c.id)})):a.addScript(c,function(a){b(a.script_id)})},this.switchToTree=function(){this.saveScript(function(a){g.path("/scripttree/"+a),b.$digest()})},this.removeAnswer=function(a){delete h.nodes[a.id],saleman_misc.removeElement(a.id,h.nodes[this.step.questionId].linksTo),j(this.step.questionId)},this.addAnswer=function(){this.newAnswer.clear(),this.doSearch(),jQuery("#modal").openModal(),jQuery("#modal").find("label").removeClass("active")},this.editAnswer=function(a){this.newAnswer.clear(),this.newAnswer.id=a.id,this.newAnswer.text=a.text,this.newAnswer.linkTo=a.next?a.next:-1,a.next&&(this.newAnswer.search=h.nodes[a.next].text.substr(0,20)),this.doSearch(),jQuery("#modal").openModal(),jQuery("#modal").find("label").addClass("active")},this.selectQuestion=function(a){this.newAnswer.linkTo=a,this.confirmAddAnswer()},this.questionActive=function(a){return a.id===this.newAnswer.linkTo},this.confirmAddAnswer=function(){var a=k();this.newAnswer.id>0&&(a.id=this.newAnswer.id),a.text=this.newAnswer.text,this.newAnswer.linkTo>0&&a.linksTo.push(this.newAnswer.linkTo),h.nodes[a.id]=a,this.newAnswer.id<=0&&h.nodes[this.step.questionId].linksTo.push(a.id),jQuery("#modal").closeModal(),j(this.step.questionId)},this.newQuestion=function(a){var b=l();h.nodes[b.id]=b,h.nodes[a.id].linksTo.push(b.id),a.next=b.id,this.selectAnswer(a)},this.selectAnswer=function(a){this.hasNext()&&i.data.splice(i.current+1,i.data.length-i.current-1),i.current=i.data.length-1,a.next?(j(a.next),i.data.push(this.step),i.current=i.data.length-1):d.info("Нет дальнейшей связи для перехода")},this.quick=function(a){return a.isQuick?"Удалить из быстрых":"Добавить в быстрые"},this.canCreateNew=function(a){return a.next},this.toggleQuick=function(a){a.isQuick?jQuery.each(o.quickLinks,function(b,c){return c.id===a.id?(o.quickLinks.splice(b,1),!1):void 0}):o.quickLinks.push(a),a.isQuick=!a.isQuick};var m=function(a){var b=null;return jQuery.each(a,function(a,c){return c?(b=c,!1):void 0}),b},n=c.id?1*c.id:!1;this.scriptId=n?n:-1;var o=(c.nodeId?1*c.nodeId:!1,this);n?(console.log("script fetching..."),a.findScriptById(n,function(a){a.data=JSON.parse(a.script.json_string),h=a,o.scriptName=h.script.script_name,h.nodes={};var c=null;jQuery.each(h.data,function(a,b){h.nodes[b.id]=b,b.startPoint&&(c=b.id),b.quickLink&&o.quickLinks.push(b)}),j(c),i.data.push(o.step),i.current=i.data.length-1,o.isLoading=!1,b.$digest(),console.log()})):console.error("cannot extract necessary params from route"),f.$watchCollection("scriptEditCtrl.quickLinks",function(){setTimeout(function(){jQuery("h5 + div.collection").find("[data-tooltip]").filter(":not([data-tooltip-id])").tooltip({delay:100})},0)})}]),app.controller("ScriptsController",["api","$rootScope","notification","modal",function(a,b,c,d){var e=this;e.loaded=!1,e.dataLoading=!0,e.searchString="",e.scripts=[],this.doSearch=function(){e.dataLoading=!0,e.scripts=a.findScripts(e.searchString,0,function(a){e.scripts=a.scripts,e.dataLoading=!1,b.$digest()}),e.loaded=!0},this.preDelete=function(b){d.okCancelDialog("Вы действительно хотите удалить данный скрипт? Это действие нельзя отменить!",function(){e.dataLoading=!0,a.removeScript(b,function(){e.doSearch(),e.dataLoading=!1},function(){e.dataLoading=!1})},null,"Внимание!")},this.doSearch()}]),app.controller("SupportController",["api","notification",function(a,b){this.topic="",this.message="",this.email=a.getCurrentUser().email,this.send=function(){a.sendTechSupport("Пользователь "+a.getCurrentUser().email+" ("+a.getCurrentUser().getFullName()+") прислал письмо в тех. поддержку.\nEmail: "+this.email+"\nТема: "+this.topic+"\nСообщение: "+this.message)}}]),function(){var a=30,b="http://185.87.49.173:8080/saleman",c=null,d={__store:{},setItem:function(a,b,c){this.__store[a]||(this.__store[a]={}),this.__store[a][b]=c,localStorage.setItem("app_cache",JSON.stringify(this.__store))},getItem:function(a,b){return this.__store[a]&&this.__store[a][b]?this.__store[a][b]:null},getItems:function(b,c,d){if(this.__store[b]){var e=[],f=0,g=!1;c||(c=a),d||(d=0);for(var h in this.__store[b])f++,f>c*d&&(g=!0,f=1),g&&c>=f&&e.push(this.__store[b][h]);return e}return null},removeItem:function(a,b){return this.__store[a]&&this.__store[a][b]?(delete this.__store[a][b],void localStorage.setItem("app_cache",JSON.stringify(this.__store))):null},init:function(){this.__store=localStorage.getItem("app_cache"),this.__store?this.__store=JSON.parse(this.__store):(console.warn("Warning: no data in local storage"),this.__store={})},clear:function(){this.__store={},localStorage.clear()}};d.init();var e=angular.module("api",["notify"]);e.factory("api",["notification","$rootScope",function(e,f){function g(a){var b={first_name:a.first_name,last_name:a.last_name,patron:a.patron,email:a.email};return a.password&&a.password.length>0&&(b.password=a.password),a.manager_id&&(b.account_id=a.manager_id),b}var h=function(a){e.info(a.error+" ("+a.error_description+")")},i=function(a,d,f,g,h,i){d.url=b+a,c&&(d.url+=(-1!==a.indexOf("?")?"&":"?")+"access_token="+c.accessToken),d.success=function(a){var b=!1;a.code?"1"===a.code?(f&&e.info(f),b=!0):"2"===a.code?e.info("Произошла ошибка при обращении к серверу. Обратитесь в службу технической поддержки"):"3"===a.code?e.info(g?g:"Ошибка проверки данных. Проверьте правильность введеных вами данных"):"4"===a.code&&e.info("У вас нет доступа для совершения этой операции. Обратитесь к администратору вашей системы"):(e.info("Данные подтверждены"),b=!0),b&&h?h(a):!b&&i&&i(a.code,a.message)},d.error=function(){i&&i()},d.dataType="json",d.contentType="application/json",d.data&&d.data.json_string&&(console.log("Encrypting script..."),d.data.json_string=CryptoJS.AES.encrypt(JSON.stringify(d.data.json_string),c.cipherKey).toString()),d.data=JSON.stringify(d.data),d.method||(d.method="POST"),jQuery.ajax(d)},j=null,k=function(a){a?j=setTimeout(k,1e3*(a-10)):jQuery.ajax({url:b+"/oauth/token?grant_type=refresh_token&client_id=web-client&refresh_token="+c.refreshToken,method:"GET",success:function(a){c.accessToken=a.access_token,c.refreshToken=a.refresh_token,c.expiresIn=a.expires_in,d.setItem("tokens","refresh",a.refresh_token),k(a.expires_in)},error:function(){e.notify("Невозможно соединиться с сервером")}})},l={};return l.register=function(a,b,c){i("/api/auth/register",{data:a},"Регистрация успешно прошла","Проверьте правильность введенных данных",b,"function"==typeof c?c:h)},l.login=function(a,b,e,f,g){i("/oauth/token?grant_type=password&client_id=web-client&password="+b+"&username="+a,{method:"GET"},null,null,function(b){b.error?e&&e(b):(c={email:a,accessToken:b.access_token,refreshToken:b.refresh_token,expiresIn:b.expires_in},d.setItem("tokens","refresh",b.refresh_token),k(20),i("/api/account/getInfo",{data:""},g?null:"Вход успешно выполнен",null,function(a){c.firstname=a.account.firstname,c.lastname=a.account.lastname,c.patron=a.account.patron,c.getFullName=function(){return this.lastname+" "+this.firstname+" "+this.patron},c.perms={},jQuery.each(a.account,function(a,b){var d=a.indexOf("Permission");-1!=d&&(c.perms[a.substring(0,d)]=b)}),c.isAdmin=a.account.admin,c.blocked=a.company.blocked,c.nextPayment=a.account.next_payment;var b=CryptoJS.enc.Utf8.parse(c.email+c.getFullName());c.cipherKey=CryptoJS.enc.Base64.stringify(b),e&&e(a)},h))},"function"==typeof f?f:h)},l.logout=function(a){c=null,clearTimeout(j),e.info("Вы вышли из приложения"),d.clear(),a()},l.isLoggedIn=function(){return null!==l.getCurrentUser()},l.getCurrentUser=function(){return!c&&angular.currentUser&&(c=angular.currentUser,delete angular.currentUser,f.$broadcast("authChange",{})),c},l.sendRecoverEmail=function(a){i("/api/reestablishment/preReestablish?email="+a,{method:"GET"},"На ваш email было выслано сообщение","Проверьте правильность введенных данных")},l.getAllClients=function(b,c){return c||(c=0),i("/api/client/getClients",{data:{firstname:"",lastname:"",patron:"",count:a,currentPosition:c}},null,null,function(a){a.clients.forEach(function(a,b,c){d.setItem("clients",a.client_id,a)}),b(a)},h),d.getItems("clients",a,c)},l.findClients=function(b,c,e){if(0===b.length)return l.getAllClients(c);e||(e=0),i("/api/client/getClients",{data:{firstname:"",lastname:b,patron:"",count:a,currentPosition:e}},null,null,function(a){a.clients.forEach(function(a,b,c){d.setItem("clients",a.client_id,a)}),c(a)},h);var f=[],g=null,j=d.getItems("clients");return j&&j.forEach(function(a,c,d){g=a.lastname+" "+a.firstname+" "+a.patron,-1!=g.indexOf(b)&&f.push(a)}),f},l.addClient=function(a,b,e){i("/api/client/createClient",{data:a},e?null:"Клиент сохранен в базу","Неверные данные. Проверьте корректность введенных данных",function(e){a.creator={email:c.email},a.client_id=e.client_id,d.setItem("clients",e.client_id,a),b(d.getItems("clients"))},h)},l.updateClient=function(a,b){d.setItem("clients",a.client_id,a),i("/api/client/updateClient",{data:a},"Клиент сохранен в базу","Неверные данные. Проверьте корректность введенных данных",b,h)},l.removeClient=function(a,b,c){return d.removeItem("clients",a.client_id),c?i("/api/client/removeClient",{data:{client_id:a.client_id}},null,"Невозможно удалить клиента. Обратитесь в службу поддержки",function(){b(),e.infoWithAction("Клиент успешно удален","Отмена",c)},h):i("/api/client/removeClient",{data:{client_id:a.id}},"Клиент успешно удален","Невозможно удалить клиента. Обратитесь в службу поддержки",b,h),d.getItems("clients")},l.findScripts=function(b,c,e){c||(c=0),i("/api/script/getScripts",{data:{string:b,count:a,currentPosition:c?c:0}},null,"Произошла ошибка при выборке. Обратитесь в службу поддержки",function(a){a.scripts.forEach(function(a,b,c){d.setItem("scripts",a.script_id,a)}),e(a)},h);var f=[],g=d.getItems("scripts",a,c);return g&&g.forEach(function(a,c,d){-1!=(a.script_name||a.name).toLowerCase().indexOf(b.toLowerCase())&&f.push(a)}),f},l.findScriptById=function(a,b){i("/api/script/findById",{data:{script_id:a}},null,"Невозможно получить скрипт. Пожалуйста, обратитесь в службу поддержки",function(a){"["===a.script.script.json_string.charAt(0)?(console.log("Using old plain style for script..."),a.script.script.json_string=a.script.script.json_string.replace(/\"/,'"')):(console.log("Decrypting script..."),a.script.script.json_string=CryptoJS.AES.decrypt(a.script.script.json_string,c.cipherKey).toString(CryptoJS.enc.Utf8)),b(a.script)},h)},l.addScript=function(a,b){i("/api/script/createScript",{data:{script_name:a.name,json_string:a.data}},"Скрипт успешно создан","Не удалось создать скрипт. Обратитесь в службу поддержки",function(c){a.script_id=c.script_id,d.setItem("scripts",c.script_id,a),b(c)},h)},l.updateScript=function(a,b){i("/api/script/updateScript",{data:{script_id:a.id||a.script_id||a.script.script_id,script_name:a.name,json_string:a.data}},"Скрипт успешно обновлен","Невозможно обновить скрипт. Пожалуйста, обратитесь в службу поддержки",function(c){d.setItem("scripts",a.script_id,a),b()},h)},l.removeScript=function(a,b,c){d.removeItem("scripts",a),c?i("/api/script/removeScript",{data:{script_id:a}},null,"Невозможно удалить скрипт. Обратитесь в службу поддержки",function(){b(),e.infoWithAction("Скрипт успешно удален","Отмена",c);
},h):i("/api/script/removeScript",{data:{script_id:a}},null,"Невозможно удалить скрипт. Обратитесь в службу поддержки",b,h)},l.sendTechSupport=function(a,b){i("/api/support/support",{data:{message:a}},"Ваш вопрос будет обработан в ближайшее время",null,b,h)},l.createAccount=function(a,b){i("/api/account/createAccount",{data:g(a)},"Аккаунт успешно создан","Неверные данные",function(c){d.setItem("accounts",c.account_id,a),b(c)},h)},l.updateAccount=function(a,b,c){d.setItem("accounts",a.account_id,a),i("/api/account/updateAccount",{data:g(a)},"Аккаунт успешно обновлен","Неверные данные",b,c)},l.removeAccount=function(a,b){d.removeItem("accounts",a),i("/api/account/removeAccount",{data:{account_id:a}},"Аккаунт успешно обновлен","Неверные данные",b,h)},l.findAccounts=function(b,c){return i("/api/account/getManagers",{data:{currentPosition:b&&b>=0?b:0,count:a}},null,null,function(a){a.managers.forEach(function(a,b,c){d.setItem("accounts",a.manager_id,a)}),c(a)},h),d.getItems("accounts")},l.getAccount=function(a,b){i("/api/account/findById",{data:{account_id:a}},"Аккаунт загружен","Неверные данные",b,h)},l.setPermission=function(a,b,c){var d={account_id:a};for(var e in b)d[e]=b[e];i("api/permission/give",{data:d},"Права доступа применены",null,c,h)},l}])}();var saleman_misc={removeElement:function(a,b){for(var c=0;c<b.length;c++)a===b[c]&&b.splice(c,1)}},ModelConfig={email:function(a){return{type:"string",regexp:/.+@[a-z]+\.[a-z]+/,required:a,err:"Пример: qwe@gmail.com"}},password:function(a){return{type:"string",min:6,required:a,err:"Минимум 6 символов"}},password_retype:function(a,b){return{type:"string",eq:a,required:b,err:"Пароли не совпадают"}},firstName:function(a){return{type:"string",min:1,required:a,err:"Обязательное"}},lastName:function(a){return{type:"string",min:1,required:a,err:"Обязательное"}},patron:function(a){return{type:"string",min:1,required:a,err:"Обязательное"}},companyName:function(a){return{type:"string",min:1,required:a,err:"Обязательное"}},description:function(a){return{type:"string",required:a,err:"Обязательное"}},phone:function(a){return{type:"string",regexp:/(\+7|7|8){0,1}[ -]?\d{3}[ -]?\d{3}[ -]?\d{2}[ -]?\d{2}/,required:a,err:"Пример: 8 900 123 34 45"}},website:function(a){return{type:"string",min:3,required:a}}},Models={client:function(a){var b={firstname:ModelConfig.firstName(!0),lastname:ModelConfig.lastName(!1),patron:ModelConfig.patron(!1),phone:ModelConfig.phone(!1),email:ModelConfig.email(!1)};return overrideLogic(b,a),b}};!function(){var a={manager:[{name:"Скрипты",location:"#/scripts",showBlocked:!1},{name:"База клиентов",location:"#/clients",showBlocked:!1},{name:"Задачи",location:"#/notready",showBlocked:!1},{name:"Тех. поддержка",location:"#/support",showBlocked:!0},{name:"Импорт",location:"#/convert",showBlocked:!1}],admin:[{name:"Скрипты",location:"#/scripts",showBlocked:!1},{name:"База клиентов",location:"#/clients",showBlocked:!1},{name:"Задачи",location:"#/notready",showBlocked:!1},{name:"Тех. поддержка",location:"#/support",showBlocked:!0},{name:"Статистика",location:"#/notready",showBlocked:!1},{name:"Импорт",location:"#/convert",showBlocked:!1},{name:"Аккаунты",location:"#/accounts",showBlocked:!0}],"system-admin":[{name:"Цены",location:"/#/home"},{name:"Статистика использования",location:"/#/home"},{name:"Сообщения",location:"/#/home"},{name:"Настройки приложения",location:"/#/home"}]};app.controller("NavbarController",["api","$rootScope","notification","$location",function(b,c,d,e){var f=this,g=null;this.username="initial",this.currentMenu=null,c.$on("authChange",function(){if(f.loggedIn=b.isLoggedIn(),f.username=f.loggedIn?b.getCurrentUser().getFullName():"",f.currentMenu=b.getCurrentUser().isAdmin?a.admin:a.manager,b.getCurrentUser().blocked)for(var d=0;d<f.currentMenu.length;d++)void 0!==f.currentMenu[d].showBlocked&&f.currentMenu[d]===!1&&f.currentMenu.splice(d,1);var h=e.path();if(-1!==h.indexOf("login"))e.path("/scripts"),g=f.currentMenu[0];else for(var d=0;d<f.currentMenu.length;d++)if(-1!==f.currentMenu[d].location.indexOf(h)){g=f.currentMenu[d];break}c.$digest(),e.path("/scripts")}),this.loggedIn=b.isLoggedIn(),this.logout=function(){b.logout(function(a){d.info("Вы вышли из приложения"),g=null,c.$broadcast("authChange",{})})},this.selectMenuItem=function(a){g=a},this.menuSelected=function(a){return g===a}}])}(),function(){var a=4e3,b="notifyModal",c="Внимание",d="OK",e="Отмена",f=0,g={},h=function(){var a=jQuery("#"+b);return 0===a.length?i():a},i=function(){var a=jQuery('<div id="'+b+'" class="modal modal-fixed-footer"><div class="modal-content"><h4 id="'+b+'Header">MODAL HEADER</h4><span id="'+b+'Body">BODY</span></div><div class="modal-footer" id="'+b+'Footer"></div></div>');return jQuery(document.body).append(a),a},j=function(a,c){a.find("#"+b+"Header").html("").html(c)},k=function(a,c){a.find("#"+b+"Body").html("").html(c)},l=function(a,c){a.find("#"+b+"Footer").html(""),jQuery.each(c,function(c,d){jQuery('<a id="button'+c+'" class="btn modal-action modal-close">'+d.text+"</a>").appendTo(a.find("#"+b+"Footer")).click(d.callback)})},m=angular.module("notify",[]);m.factory("notification",function(){var b={info:function(b){g[b]||(g[b]=!0,Materialize.toast(b,a,"",function(){delete g[b]}))},infoWithAction:function(b,c,d){var e=Materialize.toast("<span>"+b+'</span><a class="btn-flat yellow-text" id="not'+f+'">'+c+"</a>",a);jQuery("#not"+f++).click(function(){d(),e()})}};return b}),m.factory("modal",function(){var a={info:function(a,b){var e=h();k(e,a),b?j(e,b):j(e,c),l(e,[{text:d,callback:jQuery.noop}]),e.openModal()},okCancelDialog:function(a,b,c,f,g,i){var m=h(),n=[{text:g?g:d,callback:b?b:jQuery.noop},{text:i?i:e,callback:c?c:jQuery.noop}];k(m,a),f&&j(m,f),l(m,n),m.openModal()}};return a})}();